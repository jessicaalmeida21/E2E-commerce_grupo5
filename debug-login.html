<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login - E2E-Commerce</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .error {
            color: #dc3545;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug do Sistema de Login</h1>
    
    <div class="debug-container">
        <h2>üß™ Teste de Login</h2>
        <div class="form-group">
            <label for="test-email">Email:</label>
            <input type="email" id="test-email" value="teste@gmail.com">
        </div>
        <div class="form-group">
            <label for="test-password">Senha:</label>
            <input type="password" id="test-password" value="teste123">
        </div>
        <div class="form-group">
            <button onclick="testLogin()">Testar Login</button>
            <button onclick="clearData()" class="test-button danger">Limpar Dados</button>
        </div>
        <div id="login-status"></div>
    </div>
    
    <div class="debug-container">
        <h2>üìä Estado Atual do Sistema</h2>
        <button class="test-button" onclick="checkSystemState()">Verificar Estado</button>
        <button class="test-button" onclick="checkUsers()">Verificar Usu√°rios</button>
        <button class="test-button" onclick="checkLocalStorage()">Verificar localStorage</button>
        <button class="test-button" onclick="createTestUsers()">Criar Usu√°rios de Teste</button>
        <div id="system-status"></div>
    </div>
    
    <div class="debug-container">
        <h2>üìù Log Detalhado</h2>
        <button class="test-button danger" onclick="clearLog()">Limpar Log</button>
        <div id="log-area" class="log-area"></div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="js/database.js"></script>
    <script src="js/api-service.js"></script>
    <script src="js/products.js"></script>
    <script src="js/login.js"></script>

    <script>
        let logArea = document.getElementById('log-area');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logArea.textContent += logMessage;
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(message);
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }
        
        function clearLog() {
            logArea.textContent = '';
        }
        
        // Fun√ß√£o para testar login
        async function testLogin() {
            log('=== TESTANDO LOGIN ===');
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            log(`Tentando login com: ${email}`);
            
            try {
                // Verificar se a fun√ß√£o handleLogin existe
                if (typeof handleLogin !== 'function') {
                    log('‚ùå Fun√ß√£o handleLogin n√£o encontrada!', 'error');
                    updateStatus('login-status', 'Erro: Fun√ß√£o handleLogin n√£o encontrada', 'error');
                    return;
                }
                
                // Simular evento de submit
                const mockEvent = {
                    preventDefault: () => {}
                };
                
                // Verificar elementos do DOM
                const emailInput = document.getElementById('login-email');
                const passwordInput = document.getElementById('login-password');
                const messageElement = document.getElementById('login-message');
                
                if (!emailInput || !passwordInput) {
                    log('‚ùå Elementos do formul√°rio n√£o encontrados!', 'error');
                    log(`Email input: ${!!emailInput}, Password input: ${!!passwordInput}`);
                    updateStatus('login-status', 'Erro: Elementos do formul√°rio n√£o encontrados', 'error');
                    return;
                }
                
                // Preencher campos
                emailInput.value = email;
                passwordInput.value = password;
                
                log('Campos preenchidos');
                
                // Executar login
                await handleLogin(mockEvent);
                
                // Verificar resultado
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    log(`‚úÖ Login bem-sucedido! Usu√°rio: ${currentUser.name}`);
                    updateStatus('login-status', `Login realizado com sucesso! Usu√°rio: ${currentUser.name}`, 'success');
                } else {
                    log('‚ùå Login falhou - usu√°rio n√£o encontrado no localStorage');
                    updateStatus('login-status', 'Login falhou', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro durante login: ${error.message}`, 'error');
                updateStatus('login-status', `Erro: ${error.message}`, 'error');
            }
        }
        
        // Verificar estado do sistema
        function checkSystemState() {
            log('=== VERIFICANDO ESTADO DO SISTEMA ===');
            
            // Verificar se login.js foi carregado
            const loginLoaded = typeof handleLogin === 'function';
            log(`Login.js carregado: ${loginLoaded}`);
            
            // Verificar se usu√°rios foram inicializados
            const usersInitialized = typeof users !== 'undefined' && Array.isArray(users);
            log(`Usu√°rios inicializados: ${usersInitialized}`);
            
            // Verificar localStorage
            const hasUsers = localStorage.getItem('users') !== null;
            const hasCurrentUser = localStorage.getItem('currentUser') !== null;
            log(`localStorage.users: ${hasUsers}`);
            log(`localStorage.currentUser: ${hasCurrentUser}`);
            
            // Verificar elementos DOM
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const loginForm = document.getElementById('login-form');
            
            log(`Elementos DOM:`);
            log(`  - login-email: ${!!emailInput}`);
            log(`  - login-password: ${!!passwordInput}`);
            log(`  - login-form: ${!!loginForm}`);
            
            const status = loginLoaded && usersInitialized && emailInput && passwordInput;
            updateStatus('system-status', 
                `Sistema: ${status ? 'OK' : 'COM PROBLEMAS'}`, 
                status ? 'success' : 'error');
        }
        
        // Verificar usu√°rios
        function checkUsers() {
            log('=== VERIFICANDO USU√ÅRIOS ===');
            
            if (typeof users === 'undefined') {
                log('‚ùå Vari√°vel users n√£o definida');
                return;
            }
            
            log(`Total de usu√°rios: ${users.length}`);
            users.forEach((user, index) => {
                log(`  ${index + 1}. ${user.email} (${user.name}) - ID: ${user.id}`);
                log(`     Senha: ${user.password} | Perfil: ${user.profile} | Fixo: ${user.isFixed}`);
            });
            
            // Verificar localStorage
            const storedUsers = localStorage.getItem('users');
            if (storedUsers) {
                try {
                    const parsedUsers = JSON.parse(storedUsers);
                    log(`Usu√°rios no localStorage: ${parsedUsers.length}`);
                } catch (error) {
                    log(`‚ùå Erro ao parsear usu√°rios do localStorage: ${error.message}`);
                }
            } else {
                log('‚ùå Nenhum usu√°rio encontrado no localStorage');
            }
        }
        
        // Verificar localStorage
        function checkLocalStorage() {
            log('=== VERIFICANDO LOCALSTORAGE ===');
            
            const keys = Object.keys(localStorage);
            log(`Total de chaves: ${keys.length}`);
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (key === 'users') {
                    try {
                        const users = JSON.parse(value);
                        log(`  ${key}: ${users.length} usu√°rios`);
                    } catch (error) {
                        log(`  ${key}: ERRO - ${error.message}`);
                    }
                } else if (key === 'currentUser') {
                    try {
                        const user = JSON.parse(value);
                        log(`  ${key}: ${user.name} (${user.email})`);
                    } catch (error) {
                        log(`  ${key}: ERRO - ${error.message}`);
                    }
                } else {
                    log(`  ${key}: ${value.substring(0, 50)}...`);
                }
            });
        }
        
        // Criar usu√°rios de teste
        function createTestUsers() {
            log('=== CRIANDO USU√ÅRIOS DE TESTE ===');
            
            const testUsers = [
                {
                    id: 'test-001',
                    name: 'Cliente Teste',
                    email: 'teste@gmail.com',
                    password: 'teste123',
                    profile: 'customer',
                    createdAt: new Date().toISOString(),
                    isFixed: true
                },
                {
                    id: 'test-002',
                    name: 'Vendedor Teste',
                    email: 'vendedor@teste.com',
                    password: 'vendedor1',
                    profile: 'seller',
                    createdAt: new Date().toISOString(),
                    isFixed: true
                }
            ];
            
            try {
                localStorage.setItem('users', JSON.stringify(testUsers));
                log('‚úÖ Usu√°rios de teste criados');
                log(`  - teste@gmail.com / teste123`);
                log(`  - vendedor@teste.com / vendedor1`);
                
                // Recarregar usu√°rios se a fun√ß√£o existir
                if (typeof initializeUsers === 'function') {
                    initializeUsers();
                    log('‚úÖ Usu√°rios recarregados');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao criar usu√°rios: ${error.message}`);
            }
        }
        
        // Limpar dados
        function clearData() {
            log('=== LIMPANDO DADOS ===');
            
            localStorage.removeItem('users');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionStartTime');
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('savedEmail');
            
            log('‚úÖ Dados limpos');
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üîç Debug do Login Iniciado');
            log('Clique em "Verificar Estado" para come√ßar');
            
            // Verificar estado automaticamente
            setTimeout(() => {
                checkSystemState();
            }, 1000);
        });
    </script>
</body>
</html>
