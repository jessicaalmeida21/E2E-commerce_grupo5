<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Cat√°logo de Produtos | E2E-Commerce</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/catalog.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Cabe√ßalho -->
    <header>
        <div class="container">
            <div class="header-top">
                <div class="logo">
                    <a href="../index.html">
                        <div class="logo-icon"></div>
                        <h1>E2E-Commerce</h1>
                    </a>
                </div>
                <div class="search-bar">
                    <input type="text" placeholder="Buscar produtos, marcas e muito mais...">
                    <button><i class="fas fa-search"></i></button>
                </div>
                <div class="user-actions">
                    <div id="logged-out-actions">
                        <a href="login.html"><i class="fas fa-user"></i> Entre ou cadastre-se</a>
                    </div>
                    <div id="logged-in-actions" style="display: none;">
                        <span class="user-greeting">Ol√°, <span id="user-name-header">Usu√°rio</span>!</span>
                        <a href="welcome.html"><i class="fas fa-home"></i> In√≠cio</a>
                        <a href="profile.html"><i class="fas fa-user-cog"></i> Meu Perfil</a>
                        <a href="admin.html" id="admin-link" style="display: none;"><i class="fas fa-cogs"></i> Gest√£o</a>
                        <button id="logout-btn-header" class="btn-link"><i class="fas fa-sign-out-alt"></i> Sair</button>
                    </div>
                    <a href="cart.html" class="cart-link"><i class="fas fa-shopping-cart"></i> Carrinho <span id="cart-count" class="badge">0</span></a>
                </div>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="../index.html">In√≠cio</a></li>
                    <li><a href="catalog.html" class="active">Cat√°logo</a></li>
                    <li><a href="offers.html">Ofertas</a></li>
                    <li><a href="sellers.html">Fornecedores</a></li>
                    <li><a href="contact.html">Contato</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Conte√∫do Principal -->
    <main class="container">
        <div class="catalog-header">
            <h1><i class="fas fa-th-large"></i> Cat√°logo de Produtos</h1>
            <div class="catalog-filters">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Buscar produtos...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <select id="category-filter">
                    <option value="">Todas as categorias</option>
                </select>
                <select id="sort-filter">
                    <option value="">Ordenar por</option>
                    <option value="name-asc">Nome A-Z</option>
                    <option value="name-desc">Nome Z-A</option>
                    <option value="price-asc">Menor pre√ßo</option>
                    <option value="price-desc">Maior pre√ßo</option>
                    <option value="rating-desc">Melhor avalia√ß√£o</option>
                    <option value="discount-desc">Maior desconto</option>
                </select>
            </div>
        </div>

        <div class="catalog-content">
            <div class="products-grid" id="products-grid">
                <!-- Produtos ser√£o carregados via JavaScript -->
            </div>

            <div class="loading" id="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Carregando produtos...</span>
            </div>

            <div class="empty-catalog" id="empty-catalog" style="display: none;">
                <i class="fas fa-search"></i>
                <h2>Nenhum produto encontrado</h2>
                <p>Tente ajustar os filtros ou fazer uma nova busca.</p>
            </div>

            <div class="pagination" id="pagination">
                <!-- Pagina√ß√£o ser√° carregada via JavaScript -->
            </div>
        </div>
    </main>

    <!-- Rodap√© -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>E2E-Commerce</h3>
                    <p>Marketplace que conecta fornecedores e clientes em um ambiente de compra e venda simples, seguro e escal√°vel.</p>
                </div>
                <div class="footer-column">
                    <h3>Links √öteis</h3>
                    <ul>
                        <li><a href="about.html">Sobre N√≥s</a></li>
                        <li><a href="terms.html">Termos e Condi√ß√µes</a></li>
                        <li><a href="privacy.html">Pol√≠tica de Privacidade</a></li>
                        <li><a href="contact.html">Contato</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Atendimento</h3>
                    <ul>
                        <li><a href="faq.html">Perguntas Frequentes</a></li>
                        <li><a href="returns.html">Trocas e Devolu√ß√µes</a></li>
                        <li><a href="shipping.html">Pol√≠tica de Envio</a></li>
                        <li><a href="payment.html">Formas de Pagamento</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Redes Sociais</h3>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 E2E-Commerce. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // Cache busting com carregamento sequencial CORRIGIDO
        const timestamp = Date.now();
        const scripts = [
            '../js/database.js',        // PRIMEIRO: Database √© essencial
            '../js/products.js',        // SEGUNDO: Products precisa do database
            '../js/session-manager.js', // TERCEIRO: Session manager
            '../js/api-service.js',     // QUARTO: API service
            '../js/orders.js',          // QUINTO: Orders
            '../js/main.js',            // SEXTO: Main
            '../js/catalog.js'          // √öLTIMO: Catalog
        ];
        
        let currentScriptIndex = 0;
        let scriptsLoaded = {};
        
        function loadNextScript() {
            if (currentScriptIndex >= scripts.length) {
                console.log('‚úÖ Todos os scripts carregados com sucesso');
                
                // Verificar se componentes essenciais est√£o dispon√≠veis
                setTimeout(() => {
                    console.log('üîç Verificando componentes essenciais...');
                    console.log('Database dispon√≠vel:', typeof productsDatabase !== 'undefined');
                    console.log('ProductsModule dispon√≠vel:', typeof window.productsModule !== 'undefined');
                    
                    if (typeof productsDatabase === 'undefined') {
                        console.warn('‚ö†Ô∏è Database n√£o carregado, tentando fallback...');
                        loadDatabaseFallback();
                    }
                    
                    if (typeof window.productsModule === 'undefined') {
                        console.warn('‚ö†Ô∏è ProductsModule n√£o carregado, definindo globalmente...');
                        defineGlobalAddToCart();
                    }
                }, 500);
                
                return;
            }
            
            const script = document.createElement('script');
            const src = scripts[currentScriptIndex];
            script.src = `${src}?v=46&t=${timestamp}&r=${Math.random()}`;
            
            script.onload = () => {
                console.log(`‚úÖ Script carregado: ${src}`);
                scriptsLoaded[src] = true;
                currentScriptIndex++;
                loadNextScript();
            };
            
            script.onerror = () => {
                console.error(`‚ùå Erro ao carregar script: ${src}`);
                scriptsLoaded[src] = false;
                currentScriptIndex++;
                loadNextScript();
            };
            
            document.head.appendChild(script);
        }
        
        // Fun√ß√£o para carregar database como fallback
        function loadDatabaseFallback() {
            console.log('üîÑ Tentando carregar database via fallback...');
            const fallbackScript = document.createElement('script');
            fallbackScript.src = `../js/database.js?fallback=true&t=${Date.now()}`;
            fallbackScript.onload = () => {
                console.log('‚úÖ Database carregado via fallback');
                if (typeof productsDatabase !== 'undefined') {
                    console.log(`üìä Database cont√©m ${productsDatabase.length} produtos`);
                }
            };
            fallbackScript.onerror = () => {
                console.error('‚ùå Falha no fallback do database');
            };
            document.head.appendChild(fallbackScript);
        }
        
        // Fun√ß√£o para definir addToCart globalmente
        function defineGlobalAddToCart() {
            console.log('üîÑ Definindo addToCart globalmente...');
            
            // Definir addToCart global que funciona mesmo sem productsModule
            window.addToCart = function(productId, productName) {
                console.log(`üõí AddToCart global chamado: ${productId} - ${productName}`);
                
                try {
                    // Tentar usar productsModule primeiro
                    if (window.productsModule && typeof window.productsModule.addToCart === 'function') {
                        console.log('üîÑ Usando productsModule.addToCart...');
                        return window.productsModule.addToCart(productId);
                    }
                    
                    // Fallback direto
                    console.log('üîÑ Usando addToCart fallback direto...');
                    return addToCartFallback(productId, productName);
                    
                } catch (error) {
                    console.error('‚ùå Erro no addToCart global:', error);
                    showAddToCartFeedback(productName, false, error.message);
                    return false;
                }
            };
            
            console.log('‚úÖ AddToCart global definido');
        }
        
        // Iniciar carregamento sequencial
        loadNextScript();
        
        // Sistema de fallback para garantir que produtos sempre apare√ßam
        function fallbackLoadProducts() {
            console.log('üîÑ Executando fallback para carregamento de produtos...');
            
            if (typeof productsDatabase === 'undefined') {
                console.error('‚ùå Database n√£o dispon√≠vel para fallback');
                return;
            }
            
            const productsGrid = document.getElementById('products-grid');
            const loading = document.getElementById('loading');
            const emptyCatalog = document.getElementById('empty-catalog');
            
            if (!productsGrid) {
                console.error('‚ùå Elemento products-grid n√£o encontrado');
                return;
            }
            
            loading.style.display = 'block';
            productsGrid.innerHTML = '';
            
            let productCount = 0;
            
            Object.keys(productsDatabase).forEach(category => {
                if (Array.isArray(productsDatabase[category]) && productCount < 12) {
                    productsDatabase[category].slice(0, 12 - productCount).forEach(product => {
                        if (productCount < 12) {
                            const productCard = document.createElement('div');
                            productCard.className = 'product-card';
                            productCard.innerHTML = `
                                <div class="product-image">
                                    <img src="${product.image || 'https://via.placeholder.com/250'}" 
                                         alt="${product.title || product.name}" 
                                         onerror="this.src='https://via.placeholder.com/250'">
                                    ${product.discount ? `<div class="discount-badge">${product.discount}% OFF</div>` : ''}
                                </div>
                                <div class="product-info">
                                    <h3 class="product-title">${product.title || product.name || 'Produto'}</h3>
                                    <p class="product-category">${category}</p>
                                    <div class="product-price">
                                        <span class="current-price">R$ ${product.price || 'N/A'}</span>
                                    </div>
                                    <div class="product-rating">
                                        <div class="stars">
                                            ${'‚òÖ'.repeat(Math.floor(product.rating || 4))}${'‚òÜ'.repeat(5 - Math.floor(product.rating || 4))}
                                        </div>
                                        <span class="rating-text">(${product.rating || '4.0'})</span>
                                    </div>
                                    <button class="add-to-cart-btn" onclick="addToCart('${product.id}', '${(product.title || product.name || 'Produto').replace(/'/g, '\\\'')}')" 
                                            style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                        <i class="fas fa-shopping-cart"></i> Adicionar ao Carrinho
                                    </button>
                                </div>
                            `;
                            productsGrid.appendChild(productCard);
                            productCount++;
                        }
                    });
                }
            });
            
            loading.style.display = 'none';
            
            if (productCount > 0) {
                console.log(`‚úÖ Fallback: ${productCount} produtos carregados com sucesso`);
                emptyCatalog.style.display = 'none';
            } else {
                console.log('‚ùå Fallback: Nenhum produto encontrado');
                emptyCatalog.style.display = 'block';
            }
        }
        
        // Fun√ß√£o para adicionar ao carrinho - integrada com o sistema completo
         async function addToCart(productId, productName) {
             console.log(`üõí Adicionando ao carrinho: ${productName} (ID: ${productId})`);
             
             try {
                 // Tentar usar o sistema de carrinho do productsModule primeiro
                 if (window.productsModule && typeof window.productsModule.addToCart === 'function') {
                     console.log('‚úÖ Usando productsModule.addToCart');
                     await window.productsModule.addToCart(productId);
                     
                     // Mostrar feedback visual
                     showAddToCartFeedback(productName, true);
                     return;
                 }
                 
                 // Fallback: implementa√ß√£o direta
                 console.log('‚ö†Ô∏è Usando fallback direto para addToCart');
                 
                 // Verificar se o produto existe no database
                 if (typeof productsDatabase === 'undefined') {
                     throw new Error('Database de produtos n√£o dispon√≠vel');
                 }
                 
                 let product = null;
                 
                 // Procurar produto em todas as categorias
                 Object.keys(productsDatabase).forEach(category => {
                     if (Array.isArray(productsDatabase[category])) {
                         const found = productsDatabase[category].find(p => p.id === productId);
                         if (found) {
                             product = found;
                         }
                     }
                 });
                 
                 if (!product) {
                     throw new Error(`Produto ${productId} n√£o encontrado`);
                 }
                 
                 // Obter carrinho atual
                 let cart = JSON.parse(localStorage.getItem('userCart')) || [];
                 
                 // Verificar se produto j√° est√° no carrinho
                 const existingItem = cart.find(item => item.id === productId);
                 
                 if (existingItem) {
                     existingItem.quantity += 1;
                     console.log('üìà Quantidade incrementada:', existingItem);
                 } else {
                     const newItem = {
                         id: productId,
                         title: product.title || product.name || productName,
                         price: parseFloat(product.price) || 0,
                         image: product.image || 'https://via.placeholder.com/250',
                         quantity: 1,
                         description: product.description || '',
                         brand: product.brand || 'Marca'
                     };
                     cart.push(newItem);
                     console.log('‚ûï Novo item adicionado:', newItem);
                 }
                 
                 // Salvar carrinho
                 localStorage.setItem('userCart', JSON.stringify(cart));
                 
                 // Atualizar contador do carrinho
                 updateCartCounter();
                 
                 // Mostrar feedback visual
                 showAddToCartFeedback(productName, true);
                 
                 console.log('‚úÖ Produto adicionado ao carrinho com sucesso');
                 
             } catch (error) {
                 console.error('‚ùå Erro ao adicionar produto ao carrinho:', error);
                 showAddToCartFeedback(productName, false, error.message);
             }
         }
         
         // Fun√ß√£o para atualizar contador do carrinho
         function updateCartCounter() {
             const cart = JSON.parse(localStorage.getItem('userCart')) || [];
             const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
             
             const cartCounters = document.querySelectorAll('#cart-count, .cart-count, .cart-counter');
             cartCounters.forEach(counter => {
                 counter.textContent = totalItems;
                 counter.style.display = totalItems > 0 ? 'flex' : 'none';
             });
             
             console.log(`üî¢ Contador do carrinho atualizado: ${totalItems} itens`);
         }
         
         // Fun√ß√£o para mostrar feedback visual
         function showAddToCartFeedback(productName, success, errorMessage = '') {
             // Criar elemento de feedback
             const feedback = document.createElement('div');
             feedback.style.cssText = `
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 padding: 15px 20px;
                 border-radius: 8px;
                 color: white;
                 font-weight: bold;
                 z-index: 10000;
                 animation: slideIn 0.3s ease-out;
                 max-width: 300px;
                 box-shadow: 0 4px 12px rgba(0,0,0,0.3);
             `;
             
             if (success) {
                 feedback.style.background = '#27ae60';
                 feedback.innerHTML = `
                     <div style="display: flex; align-items: center; gap: 10px;">
                         <span style="font-size: 20px;">‚úÖ</span>
                         <div>
                             <div>Produto adicionado!</div>
                             <div style="font-size: 12px; opacity: 0.9;">${productName}</div>
                         </div>
                     </div>
                 `;
             } else {
                 feedback.style.background = '#e74c3c';
                 feedback.innerHTML = `
                     <div style="display: flex; align-items: center; gap: 10px;">
                         <span style="font-size: 20px;">‚ùå</span>
                         <div>
                             <div>Erro ao adicionar</div>
                             <div style="font-size: 12px; opacity: 0.9;">${errorMessage}</div>
                         </div>
                     </div>
                 `;
             }
             
             // Adicionar CSS de anima√ß√£o
             if (!document.getElementById('feedback-styles')) {
                 const style = document.createElement('style');
                 style.id = 'feedback-styles';
                 style.textContent = `
                     @keyframes slideIn {
                         from { transform: translateX(100%); opacity: 0; }
                         to { transform: translateX(0); opacity: 1; }
                     }
                     @keyframes slideOut {
                         from { transform: translateX(0); opacity: 1; }
                         to { transform: translateX(100%); opacity: 0; }
                     }
                 `;
                 document.head.appendChild(style);
             }
             
             document.body.appendChild(feedback);
             
             // Remover ap√≥s 3 segundos
             setTimeout(() => {
                 feedback.style.animation = 'slideOut 0.3s ease-in';
                 setTimeout(() => {
                     if (feedback.parentNode) {
                         feedback.parentNode.removeChild(feedback);
                     }
                 }, 300);
             }, 3000);
         }
         
         // Inicializar contador do carrinho ao carregar a p√°gina
         document.addEventListener('DOMContentLoaded', () => {
             updateCartCounter();
         });
        
        // Executar fallback ap√≥s 8 segundos se nenhum produto foi carregado
        setTimeout(() => {
            const productsGrid = document.getElementById('products-grid');
            if (productsGrid && productsGrid.children.length === 0) {
                console.log('‚ö†Ô∏è Nenhum produto carregado ap√≥s 8 segundos, executando fallback...');
                fallbackLoadProducts();
            }
        }, 8000);
        
        // Executar fallback ap√≥s 15 segundos independentemente (garantia extra)
        setTimeout(() => {
            const productsGrid = document.getElementById('products-grid');
            if (productsGrid && productsGrid.children.length < 3) {
                console.log('‚ö†Ô∏è Poucos produtos carregados ap√≥s 15 segundos, refor√ßando com fallback...');
                fallbackLoadProducts();
            }
        }, 15000);
    </script>
</body>
</html>
